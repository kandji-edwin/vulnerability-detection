FROM python:3.9.9-slim as base
WORKDIR /app

ARG local_user

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=off \
    PIP_DISABLE_PIP_VERSION_CHECK=on \
    POETRY_VERSION=1.1.8 \
    POETRY_HOME="/opt/poetry" \
    POETRY_NO_INTERACTION=1 \
    LOCAL_USER=$local_user

ENV PATH="$POETRY_HOME/bin:$PATH"

ADD pyproject.toml poetry.lock /app/
RUN mkdir /app/vendor
ADD vendor/* /app/vendor

RUN \
    # apt-get installs
    apt-get update && \
    apt-get install -y --no-install-recommends gcc libc6-dev make curl && \
    apt-get install -y cmake && \
    apt-get install -y cron && \
    apt-get install -y g++ && \
    apt-get install -y libpq-dev && \
    ### install poetry and dependencies
    curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/install-poetry.py | python - && \
    chmod a+x /opt/poetry/bin/poetry && \
    poetry config virtualenvs.create false && \
    poetry install

RUN apt-get install -y wget && \
    GRPC_HEALTH_PROBE_VERSION=v0.3.1 && \
    wget -qO/bin/grpc_health_probe https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/${GRPC_HEALTH_PROBE_VERSION}/grpc_health_probe-linux-amd64 && \
    chmod +x /bin/grpc_health_probe

### clean apt-get dependencies
RUN apt-get remove -y --auto-remove gcc libc6-dev curl && \
    apt-get purge -y --auto-remove gcc libc6-dev curl && \
    apt-get clean autoclean && \
    apt-get autoremove --yes && \
    rm -rf /var/lib/{apt,dpkg,cache,log}/ && \
    rm -rf /root/.cache

COPY nvd_ingestion_service/* /app
COPY nvd_ingestion_service/crontab /etc/cron.d/crontab
COPY detection_service/models.py /app/models.py
COPY poetry.lock /app/poetry.lock
COPY pyproject.toml /app/pyproject.toml

RUN chmod 0644 /etc/cron.d/crontab
RUN /usr/bin/crontab /etc/cron.d/crontab

FROM base as nvd-ingestion-service
