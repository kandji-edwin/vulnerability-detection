import os

import redis
from kandji_tools.logs import JSONFormatter
from kandji_tools.logs import setup_logging
from kandji_tools.settings import LogLevel
from kandji_tools.settings import LogSettings
from kandji_tools.settings import PostgreSQLSettings
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker


def setup_kandji_tools():
    log_settings = LogSettings(log_level=LogLevel["DEBUG"])
    formatter = JSONFormatter(record_properties=["levelname", "lineno", "module"])
    setup_logging(log_settings, formatter)


def setup_database():
    engine = create_engine(db_writer_dsn())
    session = sessionmaker(bind=engine)

    return session()


def setup_redis():
    return redis.Redis(
        host=os.getenv("REDIS_WRITER_HOST"),
        port=os.getenv("REDIS_PORT"),
    )


def postgresql_settings():
    return PostgreSQLSettings(
        postgres_user=os.getenv("POSTGRES_USER"),
        postgres_password=os.getenv("POSTGRES_PASSWORD"),
        postgres_db=os.getenv("POSTGRES_DB"),
        postgres_reader_host=os.getenv("POSTGRES_READER_HOST"),
        postgres_writer_host=os.getenv("POSTGRES_WRITER_HOST"),
    )


def db_reader_dsn():
    return postgresql_settings().postgres_reader_dsn.replace(
        "postgres://", "postgresql://"
    )


def db_writer_dsn():
    return postgresql_settings().postgres_writer_dsn.replace(
        "postgres://", "postgresql://"
    )
