import logging
import os
import time
from datetime import datetime
from datetime import timedelta
from datetime import timezone

import requests
from commands import setup_database
from commands import setup_kandji_tools
from commands import setup_redis
from models import CPECVEMatchOrm
from models import CPEOrm
from models import CVEOrm
from models import ReferenceDataOrm
from models import ReferenceDataTagOrm
from requests.adapters import HTTPAdapter
from requests.adapters import Retry
from sqlalchemy import delete
from sqlalchemy import select
from sqlalchemy.dialects.postgresql import insert


class CVEHandler:
    def __init__(self):
        self.query_url = "https://services.nvd.nist.gov/rest/json/cves/1.0/"

    def store_results(self, results):
        cves = results["result"]["CVE_Items"]

        if len(cves) > 0:
            logger.info(f"{len(cves)} new CVEs found")
        else:
            return

        cve_values = []
        ref_values = []
        ref_tag_dict = {}

        for item in cves:
            cvss_v3 = item.get("impact", {}).get("baseMetricV3", {}).get("cvssV3", {})
            description = [
                desc["value"]
                for desc in item["cve"]["description"]["description_data"]
                if desc["lang"] == "en"
            ][0]

            cve_values.append(
                {
                    CVEOrm.cve_id: item["cve"]["CVE_data_meta"]["ID"],
                    CVEOrm.severity: cvss_v3.get("baseSeverity"),
                    CVEOrm.version: cvss_v3.get("version"),
                    CVEOrm.score: cvss_v3.get("baseScore"),
                    CVEOrm.description: description,
                    CVEOrm.published_date: item["publishedDate"],
                    CVEOrm.last_modified_date: item["lastModifiedDate"],
                }
            )

            ref_tag_dict[item["cve"]["CVE_data_meta"]["ID"]] = {}
            for ref in item["cve"]["references"]["reference_data"]:
                ref_values.append(
                    {
                        ReferenceDataOrm.cve_row_id: item["cve"]["CVE_data_meta"]["ID"],
                        ReferenceDataOrm.url: ref["url"],
                    }
                )

                ref_tag_dict[item["cve"]["CVE_data_meta"]["ID"]][ref["url"]] = ref[
                    "tags"
                ]

        insert_stmt = insert(CVEOrm).values(cve_values)
        session.execute(
            insert_stmt.on_conflict_do_update(
                constraint="cves_pkey",
                set_={
                    CVEOrm.severity: insert_stmt.excluded.severity,
                    CVEOrm.version: insert_stmt.excluded.version,
                    CVEOrm.score: insert_stmt.excluded.score,
                },
            )
        )
        session.commit()

        self.delete_references(cve_values)
        self.insert_references(ref_values, ref_tag_dict)

    def insert_references(self, ref_values, ref_tag_dict):
        references = []

        insert_ref_stmt = (
            insert(ReferenceDataOrm)
            .values(ref_values)
            .returning(
                ReferenceDataOrm.id, ReferenceDataOrm.cve_row_id, ReferenceDataOrm.url
            )
        )
        references = session.execute(insert_ref_stmt).fetchall()

        tag_values = []
        for ref in references:
            for tag in ref_tag_dict.get(ref.cve_row_id, {}).get(ref.url, []):
                tag_values.append(
                    {
                        ReferenceDataTagOrm.reference_data_id: ref.id,
                        ReferenceDataTagOrm.tag: tag,
                    }
                )

        if tag_values:
            insert_tag_stmt = insert(ReferenceDataTagOrm).values(tag_values)
            session.execute(insert_tag_stmt)

        session.commit()

    def delete_references(self, cve_values):
        cve_ids = [cve[CVEOrm.cve_id] for cve in cve_values]
        delete_stmt = delete(ReferenceDataOrm).where(
            ReferenceDataOrm.cve_row_id.in_(cve_ids)
        )
        session.execute(delete_stmt)

    def should_paginate(self, results):
        results["totalResults"] > results["resultsPerPage"]


class CPEHandler:
    def __init__(self):
        self.query_url = "https://services.nvd.nist.gov/rest/json/cpes/1.0/?addOns=cves"

    def store_results(self, results):
        cpes = results["result"]["cpes"]

        if len(cpes) > 0:
            logger.info(f"{len(cpes)} new CPEs found")
        else:
            return

        cpe_values = []
        cpe_cve_match_values = []
        for item in cpes:
            cpe_values.append({CPEOrm.cpe_id: item["cpe23Uri"]})

            vulnerabilities = item["vulnerabilities"]
            if "" in vulnerabilities:
                vulnerabilities.remove("")

            for cve_id in vulnerabilities:
                cpe_cve_match_values.append(
                    {
                        CPECVEMatchOrm.cve_row_id: cve_id,
                        CPECVEMatchOrm.cpe_row_id: item["cpe23Uri"],
                    }
                )

        insert_cpe_stmt = insert(CPEOrm).values(cpe_values)
        session.execute(insert_cpe_stmt.on_conflict_do_nothing(constraint="cpes_pkey"))

        if cpe_cve_match_values:
            stored_cve_ids = self.get_stored_cve_ids(cpe_cve_match_values)

            valid_matches = list(
                filter(
                    lambda match: match[CPECVEMatchOrm.cve_row_id] in stored_cve_ids,
                    cpe_cve_match_values,
                )
            )

            logger.info(f"{len(valid_matches)} new cpe/cve matches found")

            self.delete_cpe_cve_matches(valid_matches)

            insert_cpe_cve_match_stmt = insert(CPECVEMatchOrm).values(valid_matches)
            session.execute(insert_cpe_cve_match_stmt)

        session.commit()

    def delete_cpe_cve_matches(self, cpe_cve_match_values):
        cpe_ids = [match[CPECVEMatchOrm.cpe_row_id] for match in cpe_cve_match_values]
        delete_stmt = delete(CPECVEMatchOrm).where(
            CPECVEMatchOrm.cpe_row_id.in_(cpe_ids)
        )
        session.execute(delete_stmt)

    def get_stored_cve_ids(self, collection):
        cve_ids = [item[CPECVEMatchOrm.cve_row_id] for item in collection]
        select_stmt = select(CVEOrm.cve_id).where(CVEOrm.cve_id.in_(cve_ids))
        stored_cves = session.execute(select_stmt)

        return [cve.cve_id for cve in stored_cves]

    def should_paginate(self, results):
        results["totalResults"] > results["resultsPerPage"]


class NVD:
    def __init__(self):
        self.page_size = 500
        self.index = 0
        self.datetime_format = "%Y-%m-%dT%H:%M:%S:000 UTC"
        self.start_datetime = self.get_start_datetime()
        self.end_datetime = datetime.now(timezone.utc).strftime(self.datetime_format)

    def get_recent_data(self):
        logger.info("Querying for recently published/modified CVEs...")
        self.get_recent_data_for_type(CVEHandler())

        logger.info("Querying for recently published/modified CPEs...")
        self.get_recent_data_for_type(CPEHandler())

        logger.info("Updating last_nvd_query_datetime")
        redis_conn.set("last_nvd_query_datetime", self.end_datetime)

    def get_recent_data_for_type(self, handler):
        paginate = True

        while paginate:
            results = self.get_data(handler)

            handler.store_results(results)

            if handler.should_paginate(results):
                self.index += self.page_size
                # https://nvd.nist.gov/developers recommends sleeping for 6 seconds
                #   between requests to avoid rate limiting
                time.sleep(6)
            else:
                paginate = False

    def get_data(self, handler):
        return request_session.get(
            handler.query_url,
            params={
                "modStartDate": self.start_datetime,
                "modEndDate": self.end_datetime,
                "resultsPerPage": self.page_size,
                "startIndex": self.index,
                "apikey": os.getenv("NVD_API_KEY"),
            },
            timeout=60,
        ).json()

    def get_start_datetime(self):
        start_datetime = redis_conn.get("last_nvd_query_datetime")

        if not start_datetime:
            start_datetime = (datetime.now(timezone.utc) - timedelta(days=30)).strftime(
                self.datetime_format
            )

        return start_datetime


if __name__ == "__main__":
    setup_kandji_tools()
    session = setup_database()
    logger = logging.getLogger()
    redis_conn = setup_redis()
    request_session = requests.Session()
    retries = Retry(total=3, backoff_factor=1)
    request_session.mount("https://", HTTPAdapter(max_retries=retries))

    NVD().get_recent_data()
